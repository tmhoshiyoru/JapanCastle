<!DOCTYPE html>
<html lang="zh-Hant">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>日本百大名城・續百大名城地圖</title>

    <!-- Leaflet（jsDelivr） -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.css" />

    <style>
      * { box-sizing: border-box; }
      body { margin: 0; font-family: system-ui, -apple-system, "Noto Sans TC", Arial; color: #222; }
      .topbar { position: sticky; top: 0; z-index: 1100; display: flex; justify-content: space-between; align-items: center; padding: 10px 14px; border-bottom: 1px solid #eee; background: #fff; }
      .topbar h1 { font-size: 18px; margin: 0; }
      .legend { font-size: 14px; color: #555; }
      .dot { display: inline-block; width: 10px; height: 10px; border-radius: 999px; margin: 0 4px 0 10px; vertical-align: middle; }
      .dot-100 { background: #0b6efd; }
      .dot-200 { background: #9b59b6; }
      #map { height: calc(100vh - 120px); position: relative; }
      .layer-toggle {
        position: absolute; right: 12px; top: 70px;
        background: rgba(255,255,255,0.95); border: 1px solid #eee; border-radius: 10px;
        padding: 8px 10px; font-size: 14px; box-shadow: 0 4px 14px rgba(0,0,0,.06);
        z-index: 1050;  /* ★ 讓圖例永遠在遮罩之上 */
      }
      label { display: block; margin: 4px 0; }
      .foot { padding: 10px 14px; font-size: 12px; color: #666; border-top: 1px solid #eee; background: #fff; }
      .leaflet-div-icon { background: transparent; border: none; }
      .marker-100, .marker-200 { width: 18px; height: 18px; border-radius: 999px; border: 2px solid #fff; box-shadow: 0 0 0 1px rgba(0,0,0,.2); }
      .marker-100 { background: #0b6efd; }
      .marker-200 { background: #9b59b6; }
    </style>
  </head>
  <body>
    <header class="topbar">
      <h1>日本百大名城・續百大名城地圖</h1>
      <div class="legend">
        <span class="dot dot-100" title="百名城"></span> 百名城
        <span class="dot dot-200" title="續百名城"></span> 續百名城
      </div>
    </header>

    <main>
      <div id="map"></div>
      <div id="layer-toggle" class="layer-toggle">
        <label><input type="checkbox" id="toggle-100" checked> 百名城</label>
        <label><input type="checkbox" id="toggle-200" checked> 續百名城</label>
      </div>
    </main>

    <footer class="foot">
      地圖資料 © OpenStreetMap 貢獻者 ｜ Tiles by OSM ｜ Powered by Leaflet
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
      // ===== 基本設定 =====
      const MAP_INIT = { lat: 36.2048, lng: 138.2529, zoom: 5 };
      const DATA_URL = "./data/castles.json";
      const JP_BOUNDARY_URL = "./data/japan-boundary.geojson"; // 你的精確邊界檔

      // 鎖定範圍（約略含沖繩與北海道）
      const JP_BOUNDS = L.latLngBounds([24, 122], [46, 154]);

      if (typeof L === "undefined") {
        alert("Leaflet 沒載到（可能被公司網路擋）。請改用 jsDelivr 或換網路重試。");
      }

      // 建立地圖
      const map = L.map("map", {
        zoomControl: true,
        worldCopyJump: false
      }).setView([MAP_INIT.lat, MAP_INIT.lng], MAP_INIT.zoom);

      // 鎖定日本
      map.setMinZoom(5);
      map.setMaxBounds(JP_BOUNDS);
      map.options.maxBoundsViscosity = 1.0;

      // OSM 圖磚
      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        maxZoom: 18,
        noWrap: true,
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>'
      }).addTo(map);

      // ★ 建立專用 pane，讓遮罩在底圖之上、但在 marker 與控制項之下
      const maskPane = map.createPane('maskPane');
      maskPane.style.zIndex = 350; // tiles=200, overlay=400, markers=600 → 設 350 夾在中間
      maskPane.style.pointerEvents = 'none'; // 雙保險：不攔截滑鼠事件

      // ===== 沿日本國界挖洞，外側覆蓋淺藍色（不遮住圖例） =====
      fetch(JP_BOUNDARY_URL).then(r => {
        if (!r.ok) throw new Error("找不到 data/japan-boundary.geojson");
        return r.json();
      }).then(geo => {
        const holes = collectJapanOuterRings(geo); // 多個外環 ring（[lng,lat]）

        const worldRing = [
          [-180, -90], [-180, 90], [180, 90], [180, -90], [-180, -90]
        ];

        const mask = {
          type: "Feature",
          properties: {},
          geometry: {
            type: "Polygon",
            coordinates: [worldRing, ...holes]
          }
        };

        L.geoJSON(mask, {
          pane: 'maskPane',                  // ★ 放在低 z-index pane
          style: {
            color: "#00000000",
            fillColor: "rgba(216,238,252,0.92)", // 淺藍海色
            fillOpacity: 1,
            fillRule: "evenodd"
          },
          interactive: false
        }).addTo(map);
      }).catch(err => {
        console.error(err);
      });

      function collectJapanOuterRings(geojson) {
        const rings = [];
        const feats = geojson.type === "FeatureCollection"
          ? geojson.features
          : geojson.type === "Feature"
            ? [geojson]
            : [{ type: "Feature", geometry: geojson }];

        for (const f of feats) {
          const g = f.geometry;
          if (!g) continue;
          if (g.type === "Polygon") {
            if (g.coordinates && g.coordinates[0]) rings.push(normalizeRing(g.coordinates[0]));
          } else if (g.type === "MultiPolygon") {
            for (const poly of g.coordinates || []) {
              if (poly && poly[0]) rings.push(normalizeRing(poly[0]));
            }
          }
        }
        return rings;
      }
      function normalizeRing(ring) {
        if (!ring || ring.length === 0) return ring;
        const first = ring[0], last = ring[ring.length - 1];
        if (first[0] !== last[0] || first[1] !== last[1]) return [...ring, first];
        return ring;
      }

      // ===== 名城點位層 =====
      const layer100 = L.layerGroup().addTo(map);
      const layer200 = L.layerGroup().addTo(map);

      function dotIcon(series) {
        const cls = series === "100" ? "marker-100" : "marker-200";
        return L.divIcon({
          className: `leaflet-div-icon ${cls}`,
          html: `<div class="${cls}"></div>`,
          iconSize: [18,18],
          iconAnchor: [9,9]
        });
      }

      fetch(DATA_URL).then(r => {
        if (!r.ok) throw new Error("找不到 data/castles.json（請確認資料夾與檔名大小寫）");
        return r.json();
      }).then(data => {
        data.forEach(item => {
          const marker = L.marker([item.lat, item.lng], { icon: dotIcon(item.series) })
            .bindPopup(popupHTML(item));
          if (item.series === "100") marker.addTo(layer100);
          else marker.addTo(layer200);
        });
      }).catch(err => {
        console.error(err);
        alert("載入資料失敗：" + err.message);
      });

      function popupHTML(item) {
        const tag = item.series === "100" ? "百名城" : "續百名城";
        const link = item.official_url ? `<p><a href="${item.official_url}" target="_blank" rel="noopener">官方/參考連結</a></p>` : "";
        return `
          <div>
            <strong>${item.name_ja}</strong> <span style="font-size:12px;color:#666">（${tag}）</span><br/>
            <span style="font-size:12px;color:#666">${item.prefecture || ""} ${item.name_en ? "｜"+item.name_en : ""}</span>
            ${link}
          </div>
        `;
      }

      const t100 = document.getElementById('toggle-100');
      const t200 = document.getElementById('toggle-200');
      t100.addEventListener('change', () => { if (t100.checked) layer100.addTo(map); else map.removeLayer(layer100); });
      t200.addEventListener('change', () => { if (t200.checked) layer200.addTo(map); else map.removeLayer(layer200); });
    </script>
  </body>
</html>
